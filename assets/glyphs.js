(function() {

    var run = function() {
        (function() {
            'use strict';

            var svgns = 'http://www.w3.org/2000/svg';
            var s = document.getElementById('glyphs');
            var e;

            // Comma
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJMAIN-2C';
            e.setAttributeNS(null, 'd', 'M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z');
            s.appendChild(e);

            // Latin A
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJMATHI-41';
            e.setAttributeNS(null, 'd', 'M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z');
            s.appendChild(e);

            // Latin B
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJMATHI-42';
            e.setAttributeNS(null, 'd', 'M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z');
            s.appendChild(e);

            // Latin C
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJMATHI-43';
            e.setAttributeNS(null, 'd', 'M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z');
            s.appendChild(e);

            // Star
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJAMS-2605';
            e.setAttributeNS(null, 'd', 'M367 395Q374 416 398 492T442 627T463 688Q463 692 467 692Q471 694 472 694Q478 694 484 680T523 562Q553 469 576 400L577 395H731H819Q872 395 883 394T895 384Q895 380 891 376T832 333Q794 305 767 285Q643 195 643 194L690 47Q737 -96 737 -103Q737 -111 727 -111Q721 -111 594 -18L472 71L350 -18Q223 -111 217 -111Q207 -111 207 -103Q207 -96 254 47L301 194Q301 195 241 239T118 328T51 378Q49 382 49 384Q49 392 58 393T110 395H213H367Z');
            s.appendChild(e);

            // Fraktur A
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJFRAK-41';
            e.setAttributeNS(null, 'd', 'M22 505Q22 563 94 624T271 685H280Q416 685 443 560Q447 535 447 504Q444 414 405 330L399 319L229 155Q233 154 241 153T253 150T265 145T281 135T301 119T328 93L357 64L402 92Q438 116 473 137L500 154V339Q500 528 495 593V601L559 649Q621 696 624 696L638 686L629 677Q599 650 593 638Q582 614 581 504Q580 490 580 443Q580 314 584 238Q584 235 584 224T584 210T585 199T586 187T588 176T591 164T595 152T601 137T609 121Q630 77 640 77Q661 77 703 101Q704 95 706 90L707 86V84L636 29Q618 15 601 2T574 -19T564 -25L500 121Q499 121 399 48L299 -26Q298 -26 291 -15T272 11T245 42T209 69T165 80Q120 80 58 43L48 37L40 42L32 48L122 117Q196 173 241 211Q319 280 343 327T368 447Q368 535 317 582Q264 633 199 633Q155 633 122 605T86 542Q86 518 133 467T181 387Q181 348 140 309Q113 281 73 260L64 255L50 265L59 273Q112 307 112 345Q112 363 90 387T45 441T22 505Z');
            s.appendChild(e);

            // Fraktur B
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJFRAK-42';
            e.setAttributeNS(null, 'd', 'M48 506Q48 568 120 629T268 691Q362 691 425 594L431 585L441 594Q478 628 528 657T629 686Q665 686 687 670Q703 658 718 584T753 506Q756 505 763 505Q778 505 804 512L815 516L820 496Q820 494 808 490T774 476T732 454Q720 445 708 437L675 415L640 394L625 383Q626 382 635 382Q652 382 670 379T712 364T754 336T784 289T797 220Q797 172 776 122Q769 106 766 102T745 84Q654 11 619 -8T538 -27Q483 -27 387 10T249 47Q218 47 186 34T133 8T112 -5T104 7T97 21L196 82Q259 120 284 140Q333 181 351 214Q368 251 368 353Q368 588 228 620Q222 621 205 621Q160 621 139 596Q117 569 117 548Q117 526 162 470T208 387Q208 352 179 320T104 264Q88 256 86 256Q83 256 70 266L82 274Q134 309 134 343Q134 352 130 359Q118 377 100 401T72 439T56 470T48 506ZM453 528Q457 496 457 419L458 357L488 367Q554 390 622 425Q673 449 673 453L671 454Q669 456 665 460T657 473T648 498T639 541Q629 597 616 613Q599 633 567 633Q534 633 493 599Q471 577 457 540L453 528ZM713 176Q713 252 661 295T528 339Q512 339 494 336T466 330T455 325Q454 325 452 311T444 270T425 217L420 207L304 118L319 116Q381 111 475 74T602 37Q655 37 684 79T713 176Z');
            s.appendChild(e);

            // Fraktur C
            e = document.createElementNS(svgns, 'path');
            e.id = 'MJFRAK-43';
            e.setAttributeNS(null, 'd', 'M299 585Q333 609 384 634T470 672L505 685Q506 685 513 662T531 613T548 580Q553 576 563 576Q575 576 605 585Q607 585 607 575V564Q537 532 496 527Q475 542 456 567T427 610T415 627Q410 627 398 618T382 603Q373 588 373 558T386 475T400 399Q400 337 366 303Q343 281 309 266T254 247T226 242L214 257Q214 258 223 260T251 272T287 299Q304 316 304 360Q304 396 289 451T274 532Q274 553 277 561V564H269Q205 558 172 501T139 358Q139 207 226 127T443 46Q448 46 457 46T470 47L485 48L601 106Q602 106 602 93V80Q551 48 517 25T474 -4T460 -13T443 -19Q409 -24 367 -24Q360 -24 351 -24T335 -23T326 -22Q190 -2 125 87T59 319V328Q62 412 96 487L101 500L118 512Q189 563 245 591L266 601L299 585Z');
            s.appendChild(e);
        }());

        document.body.addEventListener('touchstart', function preventZoom(e) {
            var t2 = e.timeStamp;
            var t1 = e.currentTarget.dataset.lastTouch || t2;
            var dt = t2 - t1;
            var fingers = e.touches.length;
            e.currentTarget.dataset.lastTouch = t2;

            if (!dt || dt > 500 || fingers > 1) return; // not double-tap

            e.preventDefault();
            e.target.click();
        });

        (function() {
            'use strict';

            var key = 'book-prop-v1';
            var app = Elm.Main.embed(document.getElementById('elm-content-frame'), {
                local: localStorage.getItem(key) || null
            });
            app.ports.initialize.subscribe(function(ignore) {
                schStartHereClicked = function() {
                    ga('send', 'event', 'Main', 'Start');
                    document.getElementById('initial-content-frame').remove();
                    document.getElementById('elm-content-frame').style.display = null;
                };
                if (schIsDocumentLoaded) {
                    schStartHereClicked();
                }
            });
            app.ports.sendEvent.subscribe(function(value) {
                // ga('send', 'event', 'Problem ' + (value.index + 1), 'Solved', value.label, value.steps);
                ga('send', 'event', value.category, value.action, value.label);
            });
            app.ports.setPage.subscribe(function(pathname) {
                ga('set', 'page', pathname);
                ga('send', 'pageview');
            });
            app.ports.setLocalStorage.subscribe(function(value) {
                try {
                    localStorage.setItem(key, value);
                } catch (err) {}
            });
            window.addEventListener('storage', function(event) {
                if (event.storageArea === localStorage && event.key === key) {
                    app.ports.onLocalStorageChange.send(event.newValue);
                }
            }, false);
            app.ports.copy.subscribe(function(text) {
                var textArea = document.createElement('textarea');
                textArea.style.position = 'fixed';
                textArea.style.top = 0;
                textArea.style.left = 0;
                textArea.style.width = '2em';
                textArea.style.height = '2em';
                textArea.style.padding = 0;
                textArea.style.border = 'none';
                textArea.style.outline = 'none';
                textArea.style.boxShadow = 'none';
                textArea.style.background = 'transparent';
                textArea.value = text;
                document.body.appendChild(textArea);

                if (navigator.userAgent.match(/ipad|iphone/i)) {
                    var editable = textArea.contentEditable;
                    var readOnly = textArea.readOnly;
                    textArea.contentEditable = true;
                    textArea.readOnly = false;
                    var range = document.createRange();
                    range.selectNodeContents(textArea);
                    var selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    textArea.setSelectionRange(0, 999999);
                    textArea.contentEditable = editable;
                    textArea.readOnly = readOnly;
                } else {
                    textArea.select();
                }
                try {
                    var successful = document.execCommand('copy');
                } catch (err) {
                    console.log('Oops, unable to copy');
                }
                document.body.removeChild(textArea);
            });
        }());
    };

    if (document.readyState == 'loading') {
        document.addEventListener('DOMContentLoaded', run);
    } else {
        run();
    }
}());
